#+TITLE: Vincent Demeester's .emacs.d

* Overview
:PROPERTIES:
:CUSTOM_ID: h:958fee2e-86db-4d34-bef6-d5b4f4f73000
:END:
** Canonical links to this document
:PROPERTIES:
:CUSTOM_ID: h:11f5b93f-6dd7-483c-aa44-e10471f17c22
:END:

+ HTML version :: [[https://sbr.pm/dotemacs][sbr.pm/dotemacs]]
+ Git repo :: [[https://github.com/vdemeester/emacs-config.git][github.com/vdemeester/emacs-config]]

** What is this
:PROPERTIES:
:CUSTOM_ID: h:e9d0ae1c-244c-4ad9-b0dc-c5e53b8d49ea
:END:

The present document, referred to in the source code version as =emacs.org=, contains the
bulk of my configurations for GNU Emacs. It is designed using principles of "literate
programming": a combination of ordinary language and inline code blocks. Emacs knows how
to parse this file properly so as to evaluate only the elisp ("Emacs Lisp") included
herein. The rest is for humans to make sense of my additions and their underlying
rationale.

#+BEGIN_QUOTE
Literate programming allows us to be more expressive and deliberate. Not only we can use
typography to its maximum potential, but can also employ techniques such as internal links
between sections. This makes the end product much better for end users, than a terse
script.
#+END_QUOTE

I switched back and forth on using =org-mode= and literate programming, so why re-using
it. First, I think I went for it the wrong way the first time. I copied part of the
configuration from elsewhere, sometimes without really needing what I was copying. for
some reason I think this is a common pattern when configuring Emacs. You start by using a
distribution (Doom Emacs, Spacemacs, …) or by copying configuration from all over the
place. Slowly but surely you realize this was a mistake as you didn't learn anything, so
you *reboot* your configuration.
* Legacy

This holds legacy code from the previous configuration (without org-mode). This will
slowly but surely move into an org-mode header and or disappear.

** ~early-init.el~

#+begin_src emacs-lisp :tangle early-init.el
  ;;; -*- lexical-binding: t; -*-
  ;; Do not initialise the package manager.  This is done in `init.el'.
  (setq package-enable-at-startup nil)

  ;; Do not resize the frame at this early stage.
  (setq frame-inhibit-implied-resize)

  (provide 'early-init)
#+end_src

** ~init.el~

#+begin_src emacs-lisp :tangle init.el
  ;;; -*- lexical-binding: t; -*-
  (defconst emacs-start-time (current-time))
  (defvar file-name-handler-alist-old file-name-handler-alist)

  (setq package-enable-at-startup nil
        file-name-handler-alist nil
        message-log-max 16384
        gc-cons-threshold 402653184
        gc-cons-percentage 0.6
        auto-window-vscroll nil)

  (add-hook 'after-init-hook
            `(lambda ()
               (setq file-name-handler-alist file-name-handler-alist-old
                     gc-cons-threshold 800000
                     gc-cons-percentage 0.1)
               (garbage-collect)) t)

  (let ((minver 25))
    (unless (>= emacs-major-version minver)
      (error "Your Emacs is too old -- this configuration requrise v%s or higher" minver)))

  (prefer-coding-system 'utf-8)
  (set-default-coding-systems 'utf-8)
  (set-language-environment 'utf-8)
  (set-selection-coding-system 'utf-8)
  (set-terminal-coding-system 'utf-8)

  ;;; package setup
  (require 'package)

  (setq package-archives
        '(("melpa" . "http://melpa.org/packages/")
          ("melpa-stable" . "https://stable.melpa.org/packages/")
          ("org" . "https://orgmode.org/elpa/")
          ("gnu" . "https://elpa.gnu.org/packages/")))

  (setq package-archive-priorities
        '(("melpa-stable" . 4)
          ("melpa" .  3)
          ("org" . 2)
          ("gnu" . 1)))

  (require 'tls)

  ;; From https://github.com/hlissner/doom-emacs/blob/5dacbb7cb1c6ac246a9ccd15e6c4290def67757c/core/core-packages.el#L102
  (setq gnutls-verify-error (not (getenv "INSECURE")) ; you shouldn't use this
        tls-checktrust gnutls-verify-error
        tls-program (list "gnutls-cli --x509cafile %t -p %p %h"
                          ;; compatibility fallbacks
                          "gnutls-cli -p %p %h"
                          "openssl s_client -connect %h:%p -no_ssl2 -no_ssl3 -ign_eof"))

  ;; Initialise the packages, avoiding a re-initialisation.
  (unless (bound-and-true-p package--initialized)
    (setq package-enable-at-startup nil)
    (package-initialize))

  (setq load-prefer-newer t)              ; Always load newer compiled files
  (setq ad-redefinition-action 'accept)   ; Silence advice redefinition warnings

  ;; Init `delight'
  (unless (package-installed-p 'delight)
    (package-refresh-contents)
    (package-install 'delight))

  ;; Configure `use-package' prior to loading it.
  (eval-and-compile
    (setq use-package-always-ensure nil)
    (setq use-package-always-defer nil)
    (setq use-package-always-demand nil)
    (setq use-package-expand-minimally nil)
    (setq use-package-enable-imenu-support t))

  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))

  (eval-when-compile
    (require 'use-package))

  (use-package dash) ; A modern list library

  (use-package use-package-ensure-system-package :ensure t :pin melpa)

  (require 'subr-x)
  (require 'time-date)

  ;;; Initialization
  (setq inhibit-default-init t)           ; Disable the site default settings

  (use-package exec-path-from-shell       ; Set up environment variables
    :if (display-graphic-p)
    :unless (eq system-type 'windows-nt)
    :config
    (setq exec-path-from-shell-variables
          '("PATH"               ; Full path
            "INFOPATH"           ; Info directories
            "GOPATH"             ; Golang path
            ))

    (exec-path-from-shell-initialize))

  ;; Set separate custom file for the customize interface
  (defconst vde/custom-file (locate-user-emacs-file "custom.el")
    "File used to store settings from Customization UI.")

  (use-package cus-edit                   ; Set up custom.el
    :defer t
    :config
    (setq
     custom-file vde/custom-file
     custom-buffer-done-kill nil          ; Kill when existing
     custom-buffer-verbose-help nil       ; Remove redundant help text
     custom-unlispify-tag-names nil       ; Show me the real variable name
     custom-unlispify-menu-entries nil)
    :init (load vde/custom-file 'no-error 'no-message))

  (use-package no-littering               ; Keep .emacs.d clean
    :config
    (require 'recentf)
    (add-to-list 'recentf-exclude no-littering-var-directory)
    (add-to-list 'recentf-exclude no-littering-etc-directory)

    (setq
     create-lockfiles nil
     delete-old-versions t
     kept-new-versions 6
     kept-old-versions 2
     version-control t)

    (setq
     backup-directory-alist
     `((".*" . ,(no-littering-expand-var-file-name "backup/")))
     auto-save-file-name-transforms
     `((".*" ,(no-littering-expand-var-file-name "auto-save/") t))))

  (setenv "PAGER" "cat")
  (setenv "TERM" "xterm-256color")
  (setenv "NOTMUCH_CONFIG" (expand-file-name ".config/notmuch/notmuchrc" (getenv "HOME")))

  (use-package server                     ; The server of `emacsclient'
    :config (or (server-running-p) (server-mode)))

  (use-package pinentry
    :config
    (setenv "INSIDE_EMACS" (format "%s,comint" emacs-version))
    (pinentry-start))

  ;; Confirm before quitting Emacs
  (setq confirm-kill-emacs #'y-or-n-p)

  ;;; Require files under ~/.emacs.d/lisp
  (add-to-list 'load-path (expand-file-name "lisp" user-emacs-directory))

  ;; Enable `vde-mode' unless `disable-pkg-vde-mode' is set to `t' in
  ;; `setup-var-overrides.el'.
  (when (not (bound-and-true-p disable-pkg-setup-mode))
    (use-package setup-vde-mode))

  (use-package setup-style)
  (use-package setup-keybindings)
  (use-package setup-completion)
  (use-package setup-vcs)
  (use-package setup-dired)
  (use-package setup-search)
  (use-package setup-files)
  (use-package setup-editing)
  (use-package setup-multiple-cursors)
  (use-package setup-navigating)
  (use-package setup-windows)
  (use-package setup-buffers)
  (use-package setup-projectile)
  (use-package setup-shells)
  (use-package setup-compile)
  (use-package setup-org)
  ;; Programming languages
  (use-package setup-nix)
  (use-package setup-go)
  (use-package setup-web)
  (use-package setup-docker)
  (use-package setup-hydras)
  (use-package setup-browser)
  (use-package setup-notmuch)

  ;; C-up/down onn console
  (when (not window-system)
    (define-key function-key-map "\eO1;5A"    [C-up])
    (define-key function-key-map "\eO1;5B"  [C-down])
    (define-key function-key-map "\eO1;5C" [C-right])
    (define-key function-key-map "\eO1;5D"  [C-left])
    )

  (let ((elapsed (float-time (time-subtract (current-time)
                                            emacs-start-time))))
    (message "Loading %s...done (%.3fs)" load-file-name elapsed))

  (add-hook 'after-init-hook
            `(lambda ()
               (let ((elapsed
                      (float-time
                       (time-subtract (current-time) emacs-start-time))))
                 (message "Loading %s...done (%.3fs) [after-init]"
                          ,load-file-name elapsed))) t)

  (put 'narrow-to-page 'disabled nil)
  (put 'narrow-to-region 'disabled nil)

  (put 'magit-diff-edit-hunk-commit 'disabled nil)
  ;; Local Variables:
  ;; coding: utf-8
  ;; indent-tabs-mode: nil
  ;; End:
  ;;; Finalization
  ;;; init.el ends here
#+end_src

** ~setup-browser.el~

#+begin_src emacs-lisp :tangle lisp/setup-browser.el
  ;;; -*- lexical-binding: t; -*-
  (use-package shr
    :commands (eww
               eww-browse-url)
    :custom
    (browse-url-browser-function 'eww-browse-url)
    (shr-use-fonts nil)
    (shr-use-colors nil)
    (shr-max-image-proportion 0.2)
    (shr-width (current-fill-column)))

  (use-package shr-tag-pre-highlight
    :after shr
    :config
    (add-to-list 'shr-external-rendering-functions
                 '(pre . shr-tag-pre-highlight))
    (when (version< emacs-version "26")
      (with-eval-after-load 'eww
        (advice-add 'eww-display-html :around
                    'eww-display-html--override-shr-external-rendering-functions))))

  (use-package eww
    :defer t
    :init
    (setq browse-url-browser-function
          '((".*google.*maps.*" . browse-url-generic)
            ;; Github goes to firefox, but not gist
            ("http.*\/\/github.com" . browse-url-generic)
            ("http.*\/\/github.io" . browse-url-generic)
            ("http.*\/\/gitlab.com" . browse-url-generic)
            ("http.*\/\/gitlab.io" . browse-url-generic)
            ("groups.google.com" . browse-url-generic)
            ("docs.google.com" . browse-url-generic)
            ("melpa.org" . browse-url-generic)
            ("build.*\.elastic.co" . browse-url-generic)
            (".*-ci\.elastic.co" . browse-url-generic)
            ("internal-ci\.elastic\.co" . browse-url-generic)
            ("zendesk\.com" . browse-url-generic)
            ("salesforce\.com" . browse-url-generic)
            ("stackoverflow\.com" . browse-url-generic)
            ("apache\.org\/jira" . browse-url-generic)
            ("thepoachedegg\.net" . browse-url-generic)
            ("zoom.us" . browse-url-generic)
            ("blujeans.com" . browse-url-generic)
            ("t.co" . browse-url-generic)
            ("twitter.com" . browse-url-generic)
            ("\/\/a.co" . browse-url-generic)
            ("youtube.com" . browse-url-generic)
            ("amazon.com" . browse-url-generic)
            ("slideshare.net" . browse-url-generic)
            ("." . eww-browse-url)))
    (setq shr-external-browser 'browse-url-generic)
    (setq browse-url-generic-program (executable-find "firefox"))
    (add-hook 'eww-mode-hook #'toggle-word-wrap)
    (add-hook 'eww-mode-hook #'visual-line-mode)
    :config
    (define-key eww-mode-map "o" 'eww)
    (define-key eww-mode-map "O" 'eww-browse-with-external-browser))

  (provide 'setup-browser)
#+end_src

** ~setup-org.el~

#+begin_src emacs-lisp :tangle lisp/setup-org.el
  ;;; -*- lexical-binding: t; -*-
  (defvar org-directory "~/desktop/org/")
  (defvar site-directory "~/desktop/sites/")

  (defvar org-default-projects-dir (concat org-directory "projects") "Primary tasks directory.")
  (defvar org-default-technical-dir (concat org-directory "technical") "Directory of shareable, technical notes.")
  (defvar org-default-personal-dir (concat org-directory "personal") "Directory of un-shareable, personal notes.")
  (defvar org-default-completed-dir (concat org-directory "projects/completed") "Directory of completed project files.")
  (defvar org-default-inbox-file (concat org-directory "projects/inbox.org") "New stuff collected in this file.")
  (defvar org-default-incubate-file (concat org-directory "projects/incubate.org") "Ideas simmering on back burner.")
  (defvar org-default-notes-file (concat org-directory "personal/notes.org") "Non-actionable, personal notes.")
  (defvar org-default-media-file (concat org-directory "projects/media.org") "Links to other things to check out.")
  (defvar org-default-journal-file (concat org-directory "personal/journal.org") "Journaling stuff.")

  (set-register ?i `(file . ,org-default-inbox-file))
  (set-register ?I `(file . ,org-default-incubate-file))
  (set-register ?j `(file . ,org-default-journal-file))
  (set-register ?m `(file . ,org-default-media-file))

  (defvar org-default-publish-technical (concat site-directory "sbr.pm/technical"))

  ;; Use `org-mode' instead of `lisp-interaction-mode' for scratch buffer
  (setq
   inhibit-startup-message t            ; don't show the startup message
   inhibit-startup-screen t             ; … or screen
   initial-scratch-message nil          ; empty scratch buffer
   initial-major-mode 'org-mode  ; org-mode by default
   )

  (use-package s)

  (use-package org
    :defer t
    :mode (("\\.org$" . org-mode))
    :commands (org-capture org-agenda)
    :ensure org-plus-contrib
    :hook (org-mode . vde/org-mode-hook)
    :bind (("C-c o c" . org-capture)
           ("C-c o l" . org-store-link)
           ("C-c o r r" . org-refile)
           ("C-c o r a" . org-agenda-refile)
           ("C-c o a" . org-agenda)
           ("<f12>" . org-agenda)
           ("<f11>" . org-clock-goto))
    :config
    (use-package find-lisp)
    (setq org-modules '(org-crypt
                        org-docview
                        org-habit
                        org-id
                        org-info
                        org-irc
                        org-protocol
                        org-man
                        org-git-link
                        org-notmuch))
    (setq org-todo-keywords
          '((sequence "TODO(t)" "NEXT(n)" "STARTED(s)" "|" "DONE(d!)" "CANCELED(c@/!)")
            (sequence "WAITING(w@/!)" "SOMEDAY(s)" "|" "CANCELED(c@/!)")
            (sequence "IDEA(i)" "|" "CANCELED(c@/!)")))
    (setq org-todo-state-tags-triggers '(
                                         ("CANCELLED" ("CANCELLED" . t))
                                         ("WAITING" ("WAITING" . t))
                                         (done ("WAITING"))
                                         ("TODO" ("WAITING") ("CANCELLED"))
                                         ("NEXT" ("WAITING") ("CANCELLED"))
                                         ("DONE" ("WAITING") ("CANCELLED"))))
    (setq org-blank-before-new-entry '((heading . t)
                                       (plain-list-item . nil)))

    (setq org-habit-show-habits-only-for-today nil)
    (setq org-habit-graph-column 80)
    (setq org-agenda-files (list org-default-projects-dir))
    (setq org-agenda-file-regexp "^[a-z0-9-_]+.org")

    (setq org-agenda-include-diary t)
    (setq org-use-property-inheritance t)

    (setq org-enforce-todo-dependencies t)

    (setq org-refile-use-outline-path 'file
          org-outline-path-complete-in-steps nil
          org-refile-allow-creating-parent-nodes 'confirm)

    (setq org-refile-targets (append '((org-default-media-file :level . 1)
                                       (org-default-inbox-file :level . 0))
                                     (->>
                                      (directory-files org-default-projects-dir nil ".org")
                                      (-remove-item (file-name-base org-default-media-file))
                                      (--remove (s-starts-with? "." it))
                                      (--map (format "%s/%s" org-default-projects-dir it))
                                      (--map `(,it :level . 1)))))

    (setq org-indirect-buffer-display 'dedicated-frame)
    (setq org-use-speed-commands t)

    (setq org-log-done (quote time))
    (setq org-log-redeadline (quote time))
    (setq org-log-reschedule (quote time))
    (setq org-log-into-drawer t)

    (setq org-fontify-whole-heading-line t)
    (setq org-src-fontify-natively t)
    (setq org-src-tab-acts-natively t)

    (setq org-pretty-entities t)
    (setq org-insert-heading-respect-content t)
    (setq org-ellipsis " …")

    (setq org-agenda-window-setup (quote current-window))
    (setq org-special-ctrl-a/e t)
    (setq org-special-ctrl-k t)
    (setq org-yank-adjusted-subtrees t)

    (setcar (nthcdr 4 org-emphasis-regexp-components) 10)

    (setq org-tag-alist (quote (("linux") ("nixos") ("emacs") ("org")
                                ("openshift") ("redhat") ("tektoncd") ("kubernetes") ("knative" ) ("docker")
                                ("docs") ("code") ("review")
                                (:startgroup . nil)
                                ("@home" . ?h) ("@work" . ?w) ("@errand" . ?e) ("@health" . ?l)
                                (:endgroup . nil)
                                (:startgroup . nil)
                                ("@link" . ?i) ("@read" . ?r) ("@project" . ?p)
                                (:endgroup . nil)
                                )))
    (setq org-agenda-skip-scheduled-if-done nil)

    (use-package org-super-agenda
      :config (org-super-agenda-mode))

    (setq org-agenda-span 'day
          org-agenda-compact-blocks t
          org-super-agenda-header-separator "")
    (setq org-agenda-sticky t)
    (setq org-agenda-custom-commands
          `(("n" "Personal agenda"
             ((agenda "")
              (tags-todo "+TODO=\"NEXT\""
                         ((org-agenda-overriding-header "Next items")))
              (tags-todo "@work-goals"
                         ((org-agenda-skip-function '(org-agenda-skip-if nil '(scheduled deadline)))
                          (org-agenda-overriding-header "Work")))
              (tags-todo "@home-goals"
                         ((org-agenda-skip-function '(org-agenda-skip-if nil '(scheduled deadline)))
                          (org-agenda-overriding-header "Home"))))
             ((org-super-agenda-groups
               '((:name "Important" :priority "A")
                 (:name "Done" :log closed)
                 (:name "Scheduled" :time-grid t)
                 (:name "Work" :tag "@work")
                 (:name "Perso" :tag "@home")
                 (:habit t))))
             (org-agenda-list))))

    (defun vde/is-project-p ()
      "Any task with a todo keyword subtask"
      (save-restriction
        (widen)
        (let ((has-subtask)
              (subtree-end (save-excursion (org-end-of-subtree t)))
              (is-a-task (member (nth 2 (org-heading-components)) org-todo-keywords-1)))
          (save-excursion
            (forward-line 1)
            (while (and (not has-subtask)
                        (< (point) subtree-end)
                        (re-search-forward "^\*+ " subtree-end t))
              (when (member (org-get-todo-state) org-todo-keywords-1)
                (setq has-subtask t))))
          (and is-a-task has-subtask))))

    (defun vde/is-project-subtree-p ()
      "Any task with a todo keyword that is in a project subtree.
  Callers of this function already widen the buffer view."
      (let ((task (save-excursion (org-back-to-heading 'invisible-ok)
                                  (point))))
        (save-excursion
          (vde/find-project-task)
          (if (equal (point) task)
              nil
            t))))

    (defun vde/find-project-task ()
      "Move point to the parent (project) task if any"
      (save-restriction
        (widen)
        (let ((parent-task (save-excursion (org-back-to-heading 'invisible-ok) (point))))
          (while (org-up-heading-safe)
            (when (member (nth 2 (org-heading-components)) org-todo-keywords-1)
              (setq parent-task (point))))
          (goto-char parent-task)
          parent-task)))

    (defun vde/is-task-p ()
      "Any task with a todo keyword and no subtask"
      (save-restriction
        (widen)
        (let ((has-subtask)
              (subtree-end (save-excursion (org-end-of-subtree t)))
              (is-a-task (member (nth 2 (org-heading-components)) org-todo-keywords-1)))
          (save-excursion
            (forward-line 1)
            (while (and (not has-subtask)
                        (< (point) subtree-end)
                        (re-search-forward "^\*+ " subtree-end t))
              (when (member (org-get-todo-state) org-todo-keywords-1)
                (setq has-subtask t))))
          (and is-a-task (not has-subtask)))))

    (defun vde/is-subproject-p ()
      "Any task which is a subtask of another project"
      (let ((is-subproject)
            (is-a-task (member (nth 2 (org-heading-components)) org-todo-keywords-1)))
        (save-excursion
          (while (and (not is-subproject) (org-up-heading-safe))
            (when (member (nth 2 (org-heading-components)) org-todo-keywords-1)
              (setq is-subproject t))))
        (and is-a-task is-subproject)))

    ;; Set default column view headings: Task Effort Clock_Summary
    (setq org-columns-default-format "%80ITEM(Task) %TODO %3PRIORITY %10Effort(Effort){:} %10CLOCKSUM")

    (setq org-global-properties (quote (("Effort_ALL" . "0:15 0:30 0:45 1:00 2:00 3:00 4:00 5:00 6:00 0:00")
                                        ("STYLE_ALL" . "habit"))))

    (org-clock-persistence-insinuate)
    ;; Show lot of clocking history so it's easy to pick items off the C-F11 list
    (setq org-clock-history-length 23)
    ;; Change tasks to STARTED when clocking in
    (setq org-clock-in-switch-to-state 'vde/clock-in-to-started)
    ;; Clock out when moving task to a done state
    (setq org-clock-out-when-done t)
    ;; Save the running clock and all clock history when exiting Emacs, load it on startup
    (setq org-clock-persist t)

    (defun vde/clock-in-to-started (kw)
      "Switch a task from TODO to STARTED when clocking in.
  Skips capture tasks, projects, and subprojects.
  Switch projects and subprojects from STARTED back to TODO"
      (when (not (and (boundp 'org-capture-mode) org-capture-mode))
        (cond
         ((and (member (org-get-todo-state) (list "TODO"))
               (vde/is-task-p))
          "STARTED")
         ((and (member (org-get-todo-state) (list "STARTED"))
               (vde/is-project-p))
          "TODO"))))

    (defvar org-capture-templates (list))
    (setq org-protocol-default-template-key "l")

    ;; images
    (setq org-image-actual-width nil
          org-startup-with-inline-images t)

    ;; Tasks (-> inbox)
    (add-to-list 'org-capture-templates
                 `("t" "Task Entry" entry
                   (file ,org-default-inbox-file)
                   "* %?\n:PROPERTIES:\n:CREATED:%U\n:END:\n\n%i\n\nFrom: %a"
                   :empty-lines 1))
    (add-to-list 'org-capture-templates
                 `("r" "PR Review" entry
                   (file ,org-default-inbox-file)
                   "* TODO review gh:%^{issue} :review:\n:PROPERTIES:\n:CREATED:%U\n:END:\n\n%i\n%?\nFrom: %a"
                   :empty-lines 1))
    (add-to-list 'org-capture-templates
                 `("l" "Link" entry
                   (file ,org-default-inbox-file)
                   "* %a\n%U\n%?\n%i"
                   :empty-lines 1))
    (add-to-list 'org-capture-templates
                 '("n" "Thought or Note"  entry
                   (file org-default-notes-file)
                   "* %?\n\n  %i\n\n  See: %a" :empty-lines 1))

    ;; Journal
    (add-to-list 'org-capture-templates
                 `("j" "Journal entry" entry
                   (file+datetree ,org-default-journal-file)
                   "* %^{title}\n%U\n%?\n%i\nFrom: %a"
                   :empty-lines 1 :clock-in t :clock-resume t))
    (add-to-list 'org-capture-templates
                 `("w" "Worklog (journal) entry" entry
                   (file+datetree ,org-default-journal-file)
                   "* worklog :@work:log:\n%U\n** Today\n%?\n** Next (later today, tomorrow)\n"))
    (add-to-list 'org-capture-templates
                 `("e" "Weekly review" entry
                   (file+datetree,org-default-journal-file)
                   "* weekly review :weekly:review:\n%U

  - [ ] review [[file:../projects/inbox.org][~inbox.org~]]
    Clean the file by either
    - refiling it to ~incubate.org~
    - removing it / archiving it
  - [ ] review [[file:../projects/incubate.org][~incubate.org~]]
    - Is something worth becoming a project
    - Is something not worth thinking about anymore ?
  - [ ] empty mail inbox (and create task if needed)
    - [ ] work
    - [ ] perso
  - [ ] Review next week ~F12 n w f~
  - [ ] review ~org-mode~ workflow
    - *what works, what doesn't ?*
    - *is there task / stuck projects ?*
    - *enhancement possible ?*
  - [ ] export previous agenda (somewhere)"
                   :clock-in t :clock-resume t))

    ;; Olds, most likely to remove
    (add-to-list 'org-capture-templates
                 `("b" "Blog post" entry
                   (file+headline "~/src/github.com/vdemeester/blog/content-org/posts.org" "Blog Ideas")
                   "* %?\n:PROPERTIES:\n:END:\n"))
    (add-to-list 'org-capture-templates
                 `("bl" "Blog link post" entry
                   (file+olp "~/src/github.com/vdemeester/blog/content-org/links.org" "Link")
                   "* %a\n%?\n%i"))

    (setq org-ditaa-jar-path "/home/vincent/.nix-profile/lib/ditaa.jar") ;; FIXME(vdemeester) remove /home/vincent
    ;; org-babel
    (org-babel-do-load-languages
     'org-babel-load-languages
     '((css . t)
       (dot . t)
       (ditaa . t)
       (emacs-lisp . t)
       (go . t)
       (gnuplot . t)
       (http . t)
       (js . t)
       ;;(ledger . t)
       (latex . t)
       (python . t)
       ;;(rust . t)
       (shell . t)
       ;;(typescript . t)
       ))

    (setq org-latex-listings t)

    (setq org-list-demote-modify-bullet
          '(("+" . "-") ("-" . "+")))

    (add-to-list 'ispell-skip-region-alist '(":\\(PROPERTIES\\|LOGBOOK\\):" ":END:"))
    (add-to-list 'ispell-skip-region-alist '("#\\+BEGIN_SRC" "#\\+END_SRC"))
    (add-to-list 'ispell-skip-region-alist '("#\\+BEGIN_EXAMPLE" "#\\+END_EXAMPLE"))

    ;; org-links
    ;; from http://endlessparentheses.com/use-org-mode-links-for-absolutely-anything.html
    (org-link-set-parameters "tag"
                             :follow #'endless/follow-tag-link)
    (defun endless/follow-tag-link (tag)
      "Display a list of TODO headlines with tag TAG.
  With prefix argument, also display headlines without a TODO keyword."
      (org-tags-view (null current-prefix-arg) tag))

    (org-link-set-parameters "grep"
                             :follow #'vde/follow-grep-link
                             :face '(:foreground "DarkRed" :underline t))
    (defun vde/follow-grep-link (regexp)
      "Run `rgrep' with REGEXP and FOLDER as argument,
  like this : [[grep:REGEXP:FOLDER]]."
      (setq expressions (split-string regexp ":"))
      (setq exp (nth 0 expressions))
      (grep-compute-defaults)
      (if (= (length expressions) 1)
          (progn
            (rgrep exp "*" (expand-file-name "./")))
        (progn
          (setq folder (nth 1 expressions))
          (rgrep exp "*" (expand-file-name folder))))
      )

    (org-link-set-parameters "rg"
                             :follow #'vde/follow-rg-link
                             :face '(:foreground "DarkGreen" :underline t))
    (defun vde/follow-rg-link (regexp)
      "Run `ripgrep-regexp` with REXEP and FOLDER as argument,
  like this : [[pt:REGEXP:FOLDER]]"
      (setq expressions (split-string regexp ":"))
      (setq exp (nth 0 expressions))
      (if (= (length expressions) 1)
          (progn
            (ripgrep-regexp exp (expand-file-name "./")))
        (progn
          (setq folder (nth 1 expressions))
          (ripgrep-regexp exp (file-name-as-directory (expand-file-name folder)))))
      )

    (org-link-set-parameters "gh"
                             :follow #'vde/follow-gh-link
                             :export #'vde/org-gh-export
                             :face '(:foreground "DimGrey" :underline t))
    (defun vde/org-gh-export (link description format)
      "Export a github page link from Org files."
      (let ((path (vde/gh-get-url link))
            (desc (or description link)))
        (cond
         ((eq format 'html) (format "<a hrefl=\"_blank\" href=\"%s\">%s</a>" path desc))
         ((eq format 'latex) (format "\\href{%s}{%s}" path desc))
         ((eq format 'texinfo) (format "@uref{%s,%s}" path desc))
         ((eq format 'ascii) (format "%s (%s)" desc path))
         (t path))))
    (defun vde/follow-gh-link (issue)
      "Browse github issue/pr specified"
      (browse-url (vde/gh-get-url issue)))

    (defun vde/gh-get-url (path)
      "Translate org-mode link `gh:foo/bar#1' to github url."
      (setq expressions (split-string path "#"))
      (setq project (nth 0 expressions))
      (setq issue (nth 1 expressions))
      (format "https://github.com/%s/issues/%s" project issue))

    (org-link-set-parameters
     "org"
     :complete (lambda () (+org-link-read-file "org" org-directory))
     :follow   (lambda (link) (find-file (expand-file-name link org-directory)))
     :face     (lambda (link)
                 (if (file-exists-p (expand-file-name link org-directory))
                     'org-link
                   'error)))
    (defun +org-link-read-file (key dir)
      (let ((file (read-file-name (format "%s: " (capitalize key)) dir)))
        (format "%s:%s"
                key
                (file-relative-name file dir))))
    )

  (defun vde/org-mode-hook ()
    "Org-mode hook"
    (setq show-trailing-whitespace t)
    (when (not (eq major-mode 'org-agenda-mode))
      (setq fill-column 90)
      (auto-revert-mode)
      (auto-fill-mode)
      (flyspell-mode)
      (org-indent-mode)
      (smartparens-mode)))

  (use-package org-id
    :after org
    :custom
    (org-id-link-to-org-use-id 'create-if-interactive-and-no-custom-id)
    :config
    (defun eos/org-custom-id-get (&optional pom create prefix)
      "Get the CUSTOM_ID property of the entry at point-or-marker POM.
     If POM is nil, refer to the entry at point. If the entry does
     not have an CUSTOM_ID, the function returns nil. However, when
     CREATE is non nil, create a CUSTOM_ID if none is present
     already. PREFIX will be passed through to `org-id-new'. In any
     case, the CUSTOM_ID of the entry is returned."
      (interactive)
      (org-with-point-at pom
        (let ((id (org-entry-get nil "CUSTOM_ID")))
          (cond
           ((and id (stringp id) (string-match "\\S-" id))
            id)
           (create
            (setq id (org-id-new (concat prefix "h")))
            (org-entry-put pom "CUSTOM_ID" id)
            (org-id-add-location id (buffer-file-name (buffer-base-buffer)))
            id)))))

    (defun eos/org-add-ids-to-headlines-in-file ()
      "Add CUSTOM_ID properties to all headlines in the
     current file which do not already have one."
      (interactive)
      (org-map-entries (lambda ()
                         (eos/org-custom-id-get (point) 'create)))))

  (use-package ob-go
    :after (org))
  (use-package ob-async
    :after (org))
  (use-package ob-http
    :after (org))

  (use-package org-crypt
    :after (org)
    :config
    (org-crypt-use-before-save-magic)
    (setq org-tags-exclude-from-inheritance (quote ("crypt"))))

  (use-package smartparens-org
    :after org-mode)

  (use-package ox-publish
    :config
    (setq org-html-coding-system 'utf-8-unix))
  (use-package ox-slack
    :after ox)
  (use-package ox-hugo
    :after ox
    :commands (org-hugo-slug)
    :bind (:map vde-mode-map
                ("C-c G" . org-hugo-export-wim-to-md))
    :config
    (use-package ox-hugo-auto-export))

  (use-package org-notify
    :after org
    :config
    (org-notify-start))

  (use-package org-capture-pop-frame)

  (use-package darkroom
    :custom
    (darkroom-text-scale-increase 2))
  (use-package org-tree-slide
    :after (org darkroom)
    :custom
    (org-tree-slide-breadcrumbs nil)
    (org-tree-slide-header nil)
    (org-tree-slide-slide-in-effect nil)
    (org-tree-slide-heading-emphasis nil)
    (org-tree-slide-cursor-init t)
    (org-tree-slide-modeline-display nil)
    (org-tree-slide-skip-done nil)
    (org-tree-slide-skip-comments t)
    (org-tree-slide-fold-subtrees-skipped t)
    (org-tree-slide-skip-outline-level 8)
    (org-tree-slide-never-touch-face t)
    :config
    (defun prot/org-presentation ()
      "Specifies conditions that should apply locally upon
  activation of `org-tree-slide-mode'."
      (if (eq darkroom-tentative-mode nil)
          (progn
            (darkroom-tentative-mode 1)
            (org-indent-mode 1)
            (set-frame-font "Hack-14" t t)
            (setq cursor-type '(bar . 1)))
        (darkroom-tentative-mode -1)
        (org-indent-mode -1)
        (prot/fonts-per-monitor)
        (setq cursor-type 'box)))
    :bind (("<f8>" . org-tree-slide-mode)
           :map org-tree-slide-mode-map
           ("<C-right>" . org-tree-slide-move-next-tree)
           ("<C-left>" . org-tree-slide-move-previous-tree))
    :hook (org-tree-slide-mode . prot/org-presentation))

  (use-package orgit
    :after magit)

  (provide 'setup-org)
#+end_src


** ~setup-style.el~

#+begin_src emacs-lisp :tangle lisp/setup-style.el
  ;;; -*- lexical-binding: t; -*-
  ;;; ¯\_(ツ)_/¯
  ;;; - Iosevka (https://github.com/be5invis/Iosevka)
  ;;; - Fira Sans (https://github.com/mozilla/Fira/)
  (setq font-height 110)
  (cond
   ((string= (system-name) "hokkaido")
    (setq font-height 100)))
  ;; Middle/Near East: שלום, السّلام عليكم
  (when (member "Noto Sans Arabic" (font-family-list))
    (set-fontset-font t 'arabic "Noto Sans Arabic"))
  (when (member "Noto Sans Hebrew" (font-family-list))
    (set-fontset-font t 'arabic "Noto Sans Hebrew"))

  ;; Africa: ሠላም
  (when (member "Noto Sans Ethiopic" (font-family-list))
    (set-fontset-font t 'ethiopic "Noto Sans Ethiopic"))

  (set-face-attribute 'default nil
                      :family "Fira Code" ; "Overpass Mono" to try someday
                      :height font-height)
  (set-face-attribute 'variable-pitch nil
                      :family "Fira Sans"
                      :height font-height
                      :weight 'regular)

  ;;; Utilities and key bindings
  (defun mu-reset-fonts ()
    "Reset fonts to my preferences."
    (interactive)
    (set-face-attribute 'default nil
                        :family "Fira Code"
                        :height font-height)
    (set-face-attribute 'variable-pitch nil
                        :family "Fira Sans"
                        :height font-height
                        :weight 'regular))

  (bind-key "C-c t f" #'mu-reset-fonts)

  ;;; Interface
  (use-package frame                      ; Frames
    :bind ("C-c w f" . toggle-frame-fullscreen)
    :init
    ;; Kill `suspend-frame'
    (unbind-key "C-x C-z")
    :config (add-to-list 'initial-frame-alist '(fullscreen . maximized)))

  (use-package emacs
    :custom
    (use-file-dialog nil)
    (use-dialog-box nil)
    (inhibit-splash-screen t)
    (echo-keystrokes 0.1) ; Faster echo keystrokes
    (line-number-display-limit-width 10000) ;; Avoid showing ?? in the mode line when we have long lines.
    (display-time-world-list '(("Europe/London" "London")
                               ("Europe/Paris" "Paris")
                               ("America/New_York" "Boston")
                               ("America/Los_Angeles" "San-Francisco")
                               ("Asia/Calcutta" "Bangalore")
                               ("Australia/Brisbane" "Brisbane")))
    :config
    (menu-bar-mode -1)
    (tool-bar-mode -1)
    (scroll-bar-mode -1)
    (horizontal-scroll-bar-mode -1)
    (line-number-mode 1)
    (column-number-mode 1)
    (global-hl-line-mode 1)
    (global-unset-key (kbd "C-z"))
    (global-unset-key (kbd "C-x C-z"))
    (global-unset-key (kbd "C-h h")))

  ;;; Theme
  (setq custom-safe-themes t)    ; Treat themes as safe

  (use-package doom-themes
    :config
    (load-theme 'doom-one t)
    (doom-themes-visual-bell-config)
    (doom-themes-org-config))

  (use-package solaire-mode
    :config
    (setq solaire-mode-remap-modeline nil)
    (add-hook 'after-change-major-mode-hook #'turn-on-solaire-mode)
    (add-hook 'after-revert-hook #'turn-on-solaire-mode)
    (add-hook 'minibuffer-setup-hook #'solaire-mode-in-minibuffer)
    (add-hook 'ediff-prepare-buffer-hook #'solaire-mode)
    (advice-add #'persp-load-state-from-file :after #'solaire-mode-restore-persp-mode-buffers))

  ;; Show buffer position percentage starting from top
  (setq mode-line-percent-position '(-3 "%o"))
  (defvar mu-eyebrowse-mode-line
    '(:propertize
      (:eval
       (when (bound-and-true-p eyebrowse-mode)
         (let* ((num (eyebrowse--get 'current-slot))
                (tag (when num
                       (nth 2 (assoc num (eyebrowse--get 'window-configs)))))
                (str (concat
                      " "
                      (if (and tag (< 0 (length tag)))
                          tag
                        (when num (int-to-string num)))
                      " ")))
           str)))
      face (:background "#81a2be" :foreground "#373b41"))
    "Mode line format for Eyebrowse.")

  (put 'mu-eyebrowse-mode-line 'risky-local-variable t)

  (setq-default mode-line-format
                '("%e"
                  mu-eyebrowse-mode-line
                  mode-line-front-space
                  mode-line-mule-info
                  mode-line-client
                  mode-line-modified
                  mode-line-remote
                  mode-line-frame-identification
                  mode-line-buffer-identification " " mode-line-position
                  (vc-mode vc-mode)
                  (multiple-cursors-mode mc/mode-line)
                  " " mode-line-modes
                  mode-line-end-spaces))

  (defmacro rename-modeline (package-name mode new-name)
    "Rename PACKAGE-NAME with MODE into NEW-NAME in the mode line."
    `(eval-after-load ,package-name
       '(defadvice ,mode (after rename-modeline activate)
          (setq mode-name ,new-name))))

  (defun generic-term-init ()
    (visual-line-mode -1)
    (setq-local global-hl-line-mode nil)
    (setq-local scroll-margin 0))

  (add-hook 'term-mode-hook #'generic-term-init)
  (add-hook 'shell-mode-hook #'generic-term-init)
  (add-hook 'eshell-mode-hook #'generic-term-init)

  (use-package moody
    :config
    (setq x-underline-at-descent-line t)
    (moody-replace-mode-line-buffer-identification)
    (moody-replace-vc-mode))

  (use-package minions                    ; A minor-mode menu for the mode line
    :init (minions-mode)
    :config
    (setq
     minions-mode-line-lighter "λ="
     minions-direct '(flycheck-mode)))

  (setq-default indicate-buffer-boundaries 'left)
  (setq-default indicate-empty-lines +1)

  (use-package highlight
    :ensure t
    :pin melpa)

  (use-package highlight-numbers
    :hook (prog-mode . highlight-numbers-mode))

  (use-package symbol-overlay
    :defer 4
    :bind
    ("M-s h ." . symbol-overlay-put)
    ("M-s h n" . symbol-overlay-jump-next)
    ("M-s h p" . symbol-overlay-jump-prev)
    :hook (prog-mode . symbol-overlay-mode)
    :config
    (setq symbol-overlay-idle-time 0.2))

  (use-package rainbow-delimiters
    :hook (prog-mode . rainbow-delimiters-mode))

  (use-package rainbow-mode
    :commands rainbow-mode
    :hook (prog-mode . rainbow-mode))

  (use-package visual-fill-column
    :commands visual-fill-column-mode)

  (use-package hide-mode-line-mode
    :commands hide-mode-line-mode)

  (defun set-light-theme ()
    "Set the light theme with some customization if needed."
    (interactive)
    (load-theme 'doom-one-light t))

  (defun set-dark-theme ()
    "Set the dark theme with some customization if needed."
    (interactive)
    (load-theme 'doom-one t))

  (defun theme-switcher ()
    (interactive)
    (let ((current-hour (string-to-number (format-time-string "%H"))))
      (if (and (> current-hour 6) (< current-hour 20))
          (set-light-theme)
        (set-dark-theme))))

  ;; Run at every 3600 seconds, after 0s delay
  (run-with-timer 0 3600 'theme-switcher)

  (provide 'setup-style)
#+end_src
